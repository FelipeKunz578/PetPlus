<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <title>Tutores – PetPlus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/app.css">
    <link rel="icon" href="css/icone.png" type="image/png">
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-orange" style="background-color:#FF7A59;">
        <div class="container"> <a class="navbar-brand" href="/index.html"><img class="img" src="css/Logo PETPLUS com Pata Estilizada.png" alt=""></a>
            <div class="navbar-nav"> <a class="nav-link" href="/pets.html">Pets</a> <a class="nav-link active"
                    href="/tutores.html">Tutores</a> <a class="nav-link" href="/servicos.html">Serviços</a> <a
                    class="nav-link" href="/atendimentos.html">Atendimentos</a> </div>
                    <div class="sairBotao"><a class="navbar-link" href="/login.html">Sair</a> </div>
        </div>
    </nav>

    <main class="container py-4">
        <h1 class="h3 mb-3">Gerenciar Tutores</h1>
        <form id="tutorForm" class="row g-3 mb-4"> <input type="hidden" id="tutorId">
            <div class="col-md-4"> <label class="form-label">Nome*</label>
                <input id="nome" class="form-control" required> </div>
            <div class="col-md-4"> <label class="form-label">CPF</label> <input id="cpf" class="form-control"> </div>
            <div class="col-md-4"> <label class="form-label">Telefone*</label> <input id="telefone" class="form-control" required> </div>
            <div class="col-md-6"> <label class="form-label">Email</label> <input id="email" type="email" class="form-control"> </div>
            <div class="col-12"> <button class="btn btn-primary" type="submit">Salvar</button> <button
                    class="btn btn-secondary" type="button" id="btnLimpar">Limpar</button> </div>
        </form>

        <form class="pesquisar" id="formPesquisa">
         <input type="search" name="pesquisa" id="pesquisa" placeholder="Pesquisar Tutor...">
        <input type="button" value="Pesquisar" id="btnPesquisar">
         <input type="button" value="Limpar" id="btnLimparPesquisa" onclick="location.reload()">
        </form>

        <div class="table-responsive">
            <table class="table table-striped align-middle" id="tblTutores">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Telefone</th>
                        <th>Email</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script>
(async () => {
    const els = {
        form: document.getElementById('tutorForm'),
        id: document.getElementById('tutorId'),
        nome: document.getElementById('nome'),
        cpf: document.getElementById('cpf'),
        telefone: document.getElementById('telefone'),
        email: document.getElementById('email'),
        tblBody: document.querySelector('#tblTutores tbody'),
        btnLimpar: document.getElementById('btnLimpar'),
        formPesquisa: document.getElementById('formPesquisa'),
        inputPesquisa: document.getElementById('pesquisa'),
        btnPesquisar: document.getElementById('btnPesquisar')
    };

    function toRow(t) {
        return `
            <tr>
                <td>${t.id}</td>
                <td>${t.nome}</td>
                <td>${t.cpf ?? ''}</td>
                <td>${t.telefone}</td>
                <td>${t.email ?? ''}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${t.id}">Editar</button>
                    <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${t.id}">Excluir</button>
                </td>
            </tr>`;
    }

    function limpar() { 
        els.id.value = ''; 
        els.form.reset(); 
    }

    async function carregarTutores() {
        try {
            const res = await fetch('/api/tutores/listaTutor');
            const list = await res.json();
            els.tblBody.innerHTML = list.map(toRow).join('');
        } catch (err) {
            console.error('Erro ao carregar tutores:', err);
        }
    }

    async function saveTutor(payload) {
        const url = payload.id ? `/api/tutores/${payload.id}` : '/api/tutores/adicionarTutor';
        const method = payload.id ? 'PUT' : 'POST';
        const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('Erro na requisição');
        return res.json();
    }

    async function pesquisarTutores() {
        const query = els.inputPesquisa.value.trim().toLowerCase();
        const res = await fetch('/api/tutores/listaTutor');
        const list = await res.json();
        const filtrados = query ? list.filter(t => t.nome.toLowerCase().includes(query)) : list;
        els.tblBody.innerHTML = filtrados.map(toRow).join('');
    }

    // Eventos
    els.form.addEventListener('submit', async e => {
        e.preventDefault();
        const payload = {
            id: els.id.value ? Number(els.id.value) : undefined,
            nome: els.nome.value.trim(),
            cpf: els.cpf.value.trim() || null,
            telefone: els.telefone.value.trim(),
            email: els.email.value.trim() || null
        };
        try {
            await saveTutor(payload);
            await carregarTutores();
            limpar();
            alert('Registro salvo com sucesso!');
        } catch (err) {
            alert('Erro ao salvar: ' + (err.message || 'verifique os dados'));
        }
    });

    els.btnLimpar.addEventListener('click', limpar);

    els.tblBody.addEventListener('click', async e => {
        const btn = e.target.closest('button'); 
        if (!btn) return; 
        const id = Number(btn.dataset.id);
        if (btn.dataset.act === 'edit') {
            try {
                const res = await fetch(`/api/tutores/${id}`);
                const t = await res.json();
                els.id.value = t.id; 
                els.nome.value = t.nome; 
                els.cpf.value = t.cpf || ''; 
                els.telefone.value = t.telefone; 
                els.email.value = t.email || '';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) { alert('Erro ao carregar registro: ' + (err.message || '')); }
        } else if (btn.dataset.act === 'del') {
            if (!confirm('Confirma exclusão?')) return;
            try {
                const res = await fetch(`/api/tutores/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Erro ao excluir');
                await carregarTutores();
            } catch (err) { alert('Erro ao excluir: ' + (err.message || '')); }
        }
    });

    els.btnPesquisar.addEventListener('click', pesquisarTutores);
    els.formPesquisa.addEventListener('submit', e => { e.preventDefault(); pesquisarTutores(); });

    await carregarTutores();
})();
</script>

</body>

</html>
