<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <title>Pets – PetPlus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/app.css">
  <link rel="icon" href="css/icone.png" type="image/png">
</head>

<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-orange" style="background-color:#FF7A59;">
    <div class="container"> <a class="navbar-brand" href="/index.html"><img class="img"
          src="css/Logo PETPLUS com Pata Estilizada.png" alt=""></a>
      <div class="navbar-nav"> <a class="nav-link active" href="/pets.html">Pets</a> <a class="nav-link"
          href="/tutores.html">Tutores</a> <a class="nav-link" href="/servicos.html">Serviços</a> <a class="nav-link"
          href="/atendimentos.html">Atendimentos</a> </div>
      <div class="sairBotao"><a class="navbar-link" href="/login.html">Sair</a> </div>
    </div>
  </nav>

  <main class="container py-4">
    <h1 class="h3 mb-3">Gerenciar Pets</h1>

    <form id="petForm" class="row g-3 mb-4">
      <input type="hidden" id="petId">

      <div class="col-md-3">
        <label class="form-label">Nome*</label>
        <input id="nome" class="form-control" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Espécie*</label>
        <input id="especie" class="form-control" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Raça</label>
        <input id="raca" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Nascimento</label>
        <input id="dataNascimento" type="date" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label">Tutor*</label>
        <select id="tutorId" class="form-select" required></select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Foto</label>
        <input id="fileInput" type="file" name="file" class="form-control">
      </div>

      <div class="col-12">
        <button class="btn btn-primary" type="submit">Salvar</button>
        <button class="btn btn-secondary" type="button" id="btnLimpar">Limpar</button>
      </div>
    </form>

    <!-- upload agora é feito junto com o formulário Salvar (multipart) -->

    <form class="pesquisar" id="formPesquisa">
      <input type="search" name="pesquisa" id="pesquisa" placeholder="Pesquisar pet...">
      <input type="button" value="Pesquisar" id="btnPesquisar">
      <input type="button" value="Limpar" id="btnLimparPesquisa" onclick="location.reload()">
    </form>

    <div class="table-responsive">
      <table class="table table-striped align-middle" id="tblPets">
        <thead>
          <tr>
            <th>#</th>
            <th>Nome</th>
            <th>Espécie</th>
            <th>Raça</th>
            <th>Tutor</th>
            <th>Foto</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script>
    const els = {
      form: document.getElementById('petForm'),
      petId: document.getElementById('petId'),
      nome: document.getElementById('nome'),
      especie: document.getElementById('especie'),
      raca: document.getElementById('raca'),
      dataNascimento: document.getElementById('dataNascimento'),
      tutorId: document.getElementById('tutorId'),
      tblBody: document.querySelector('#tblPets tbody'),
      btnLimpar: document.getElementById('btnLimpar')
    };

    // monta a linha da tabela
    function toRow(p) {
      return `
        <tr>
          <td>${p.id}</td>
          <td>${p.nome}</td>
          <td>${p.especie}</td>
          <td>${p.raca ?? ''}</td>
          <td>${p.tutor?.nome ?? '-'}</td>
          <td>${p.foto ? `<img src="/uploads/${p.foto}"
           alt="Foto de ${p.nome}" width="200" >` : 'Sem foto'}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${p.id}">Editar</button>
            <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${p.id}">Excluir</button>
          </td>
        </tr>`;
    }

    function limpar() {
      els.petId.value = '';
      els.form.reset();
    }

    async function carregarTutores() {
      try {
        const response = await fetch('/api/tutores/listaTutor');
        if (!response.ok) throw new Error('Erro ao buscar tutores');
        const tutores = await response.json();
        els.tutorId.innerHTML = '<option value="">Selecione um tutor...</option>' +
          tutores.map(t => `<option value="${t.id}">${t.nome}</option>`).join('');
      } catch (err) {
        console.error('Erro ao carregar tutores:', err);
      }
    }

    async function carregarPets() {
      try {
        const response = await fetch('/api/pets');
        if (!response.ok) throw new Error('Erro ao buscar pets');
        const pets = await response.json();
        els.tblBody.innerHTML = pets.map(toRow).join('');
      } catch (err) {
        console.error('Erro ao carregar pets:', err);
        alert('Erro ao carregar lista de pets.');
      }
    }


    els.form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // enviar como multipart/form-data (inclui arquivo se selecionado)
      try {
        const formData = new FormData();
        formData.append('nome', els.nome.value.trim());
        formData.append('especie', els.especie.value.trim());
        formData.append('raca', els.raca.value.trim() || '');
        formData.append('dataNascimento', els.dataNascimento.value || '');
        formData.append('tutorId', Number(els.tutorId.value));

        const fileInput = document.getElementById('fileInput');
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
          formData.append('file', fileInput.files[0]);
        }

        const url = els.petId.value
          ? `/api/pets/${els.petId.value}`
          : '/api/pets';
        const method = els.petId.value ? 'PUT' : 'POST';

        const response = await fetch(url, { method, body: formData });
        if (!response.ok) {
          const error = await response.text();
          throw new Error(error || 'Erro ao salvar');
        }

        await carregarPets();
        limpar();
        alert('Registro salvo com sucesso!');
      } catch (err) {
        console.error('Erro ao salvar:', err);
        alert('Erro ao salvar: ' + (err.message || 'verifique os dados'));
      }
    });

    els.tblBody.addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = Number(btn.dataset.id);

      if (btn.dataset.act === 'edit') {
        const response = await fetch(`/api/pets/${id}`);
        const p = await response.json();
        els.petId.value = p.id;
        els.nome.value = p.nome;
        els.especie.value = p.especie;
        els.raca.value = p.raca || '';
        els.dataNascimento.value = p.dataNascimento || '';
  els.tutorId.value = p.tutor?.id || '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } else if (btn.dataset.act === 'del') {
        if (confirm('Confirma exclusão?')) {
          await fetch(`/api/pets/${id}`, { method: 'DELETE' });
          await carregarPets();
        }
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      await carregarTutores();
      await carregarPets();
    });

    // upload form with AJAX to get filename and set hidden foto input
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
      uploadForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const fd = new FormData(uploadForm);
        try {
          const res = await fetch('/upload', { method: 'POST', body: fd });
          const json = await res.json();
          if (!res.ok) {
            alert(json.error || 'Erro no upload');
            return;
          }
          // preenche o campo foto do formulário do pet
          if (!els.foto) els.foto = document.getElementById('foto');
          if (els.foto) els.foto.value = json.fileName;
          alert('Upload realizado: ' + json.fileName);
        } catch (err) {
          console.error('Erro no upload:', err);
          alert('Erro ao enviar arquivo');
        }
      });
    }

    const formPesquisa = document.getElementById('formPesquisa');
    const inputPesquisa = document.getElementById('pesquisa');
    const btnPesquisar = document.getElementById('btnPesquisar');

    // Função para pesquisar pets
    async function pesquisarPets() {
      const query = inputPesquisa.value.trim().toLowerCase();
      if (!query) {
        await carregarPets(); // se estiver vazio, carrega todos
        return;
      }

      try {
        const response = await fetch('/api/pets');
        if (!response.ok) throw new Error('Erro ao buscar pets');
        const pets = await response.json();
        // filtra pelo nome
        const filtrados = pets.filter(p => p.nome.toLowerCase().includes(query));
        els.tblBody.innerHTML = filtrados.map(toRow).join('');
      } catch (err) {
        console.error('Erro ao pesquisar pets:', err);
        alert('Erro ao pesquisar pets.');
      }
    }

    // botão chama a pesquisa
    btnPesquisar.addEventListener('click', pesquisarPets);

    // permitir Enter para disparar pesquisa
    formPesquisa.addEventListener('submit', (e) => {
      e.preventDefault();
      pesquisarPets();
    });
  </script>
</body>

</html>