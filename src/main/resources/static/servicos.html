<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <title>Serviços – PetPlus</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/app.css">
    <link rel="icon" href="css/icone.png" type="image/png">
</head>

<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-orange" style="background-color:#FF7A59;">
        <div class="container"> <a class="navbar-brand" href="/index.html"><img class="img" src="css/Logo PETPLUS com Pata Estilizada.png" alt=""></a>
            <div class="navbar-nav"> <a class="nav-link" href="/pets.html">Pets</a> <a class="nav-link"
                    href="/tutores.html">Tutores</a> <a class="nav-link active" href="/servicos.html">Serviços</a> <a
                    class="nav-link" href="/atendimentos.html">Atendimentos</a> </div>
                    <div class="sairBotao"><a class="navbar-link" href="/login.html">Sair</a> </div>
        </div>
    </nav>
    <main class="container py-4">
        <h1 class="h3 mb-3">Gerenciar Serviços</h1>
        <form id="servicoForm" class="row g-3 mb-4"> <input type="hidden" id="servicoId">
            <div class="col-md-3"> <label class="form-label">Descrição*</label>

                <input id="nome" class="form-control descricao-large" required>
            </div>
            <div class="col-md-3"> <label class="form-label">Valor*</label> <input id="valor" type="number" class="form-control"
                    required> </div>
            <div class="col-md-3"> <label class="form-label">Duração do serviço</label> <input id="duracao" type="time" class="form-control"> </div>
            <div class="col-md-6"> <label class="form-label">Observações</label> <textarea id="observacoes" class="form-control" rows="3"></textarea> </div>
            <div class="col-12"> <button class="btn btn-primary" type="submit">Salvar</button> <button
                    class="btn btn-secondary" type="button" id="btnLimpar">Limpar</button> </div>
        </form>
        <div class="table-responsive">
            <table class="table table-striped align-middle" id="tblPets">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Duração</th>
                        <th>Observações</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>
    <script src="/js/api.js"></script>
<script>
(async function () {
  const els = {
    form: document.getElementById('servicoForm'),
    id: document.getElementById('servicoId'),
    nome: document.getElementById('nome'),
    valor: document.getElementById('valor'),
    duracao: document.getElementById('duracao'),
    observacoes: document.getElementById('observacoes'),
    tblBody: document.querySelector('#tblPets tbody'),
    btnLimpar: document.getElementById('btnLimpar')
  };

  function toRow(s) {
    return `
      <tr>
        <td>${s.id}</td>
        <td>${s.descricao}</td>
        <td>R$ ${Number(s.valor).toFixed(2)}</td>
        <td>${s.duracao ?? '-'}</td>
        <td>${s.observacoes ?? '-'}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-act="edit" data-id="${s.id}">Editar</button>
          <button class="btn btn-sm btn-outline-danger" data-act="del" data-id="${s.id}">Excluir</button>
        </td>
      </tr>`;
  }

  function limpar() {
    els.id.value = '';
    els.form.reset();
  }

  async function carregarServicos() {
    try {
      const resp = await fetch('/api/servicos/listaServico');
      if (!resp.ok) throw new Error('Erro ao listar serviços');
      const lista = await resp.json();
      els.tblBody.innerHTML = lista.map(toRow).join('');
    } catch (err) {
      console.error(err);
      alert('Erro ao carregar serviços');
    }
  }

  els.form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
      descricao: els.nome.value.trim(),
        valor: els.valor.value === '' ? null : parseFloat(els.valor.value),
      duracao: els.duracao.value || null,
      observacoes: els.observacoes.value.trim() || null
    };

      // validação cliente: evita enviar valor nulo ou NaN
      if (!payload.descricao) return alert('Descrição é obrigatória');
      if (payload.valor === null || Number.isNaN(payload.valor)) return alert('Valor é obrigatório e deve ser numérico');

    try {
      if (els.id.value) {
        await fetch(`/api/servicos/${els.id.value}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } else {
        await fetch('/api/servicos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }

      await carregarServicos();
      limpar();
      alert('Serviço salvo com sucesso!');
    } catch (err) {
      console.error(err);
      alert('Erro ao salvar serviço.');
    }
  });

  els.btnLimpar.addEventListener('click', limpar);

  els.tblBody.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;

    const id = Number(btn.dataset.id);

    if (btn.dataset.act === 'edit') {
      const resp = await fetch(`/api/servicos/${id}`);
      if (!resp.ok) return alert('Erro ao buscar serviço');
      const s = await resp.json();

      els.id.value = s.id;
      els.nome.value = s.descricao;
      els.valor.value = s.valor;
      els.duracao.value = s.duracao ?? '';
      els.observacoes.value = s.observacoes ?? '';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else if (btn.dataset.act === 'del') {
      if (confirm('Confirma exclusão?')) {
        await fetch(`/api/servicos/${id}`, { method: 'DELETE' });
        await carregarServicos();
      }
    }
  });

  await carregarServicos();
})();
</script>

</body>

</html>